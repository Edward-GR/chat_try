<!DOCTYPE html>
<html>
<head>
  <title>Ð§Ð°Ñ‚</title>
  <script src="https://cdn.jsdelivr.net/npm/pywebio@latest/dist/pywebio.js"></script>
</head>
<body>
  <div id="chat-container"></div>
  <script>
    pywebio.main(async () => {
      const msg_box = pywebio.output();
      pywebio.scrollable(msg_box, {height: 300, keepBottom: true});

      const nickname = await pywebio.input("Ð’Ð¾Ð¹Ñ‚Ð¸ Ð² Ñ‡Ð°Ñ‚", {required: true, placeholder: "Ð’Ð°ÑˆÐµ Ð¸Ð¼Ñ", validate: n => n in online_users || n == 'ðŸ“¢' ? "Ð¢Ð°ÐºÐ¾Ð¹ Ð½Ð¸Ðº ÑƒÐ¶Ðµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ!" : null});
      online_users.add(nickname);

      chat_msgs.push((ðŸ“¢, ${nickname} Ð¿Ñ€Ð¸ÑÐ¾ÐµÐ´Ð¸Ð½Ð¸Ð»ÑÑ Ðº Ñ‡Ð°Ñ‚Ñƒ!));
      msg_box.append(pywebio.markdown(ðŸ“¢ ${nickname} Ð¿Ñ€Ð¸ÑÐ¾ÐµÐ´Ð¸Ð½Ð¸Ð»ÑÑ Ðº Ñ‡Ð°Ñ‚Ñƒ));

      const refresh_task = pywebio.runAsync(refreshMsg(nickname, msg_box));

      while (true) {
        const data = await pywebio.inputGroup("ðŸ’­ ÐÐ¾Ð²Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ", [
          pywebio.input({ placeholder: "Ð¢ÐµÐºÑÑ‚ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ ...", name: "msg" }),
          pywebio.actions({ name: "cmd", buttons: ["ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ", { label: "Ð’Ñ‹Ð¹Ñ‚Ð¸ Ð¸Ð· Ñ‡Ð°Ñ‚Ð°", type: 'cancel' }] })
        ], {
          validate: m => m["cmd"] == "ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ" && !m['msg'] ? ('msg', "Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ñ‚ÐµÐºÑÑ‚ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ!") : null
        });

        if (data === null) {
          break;
        }

        msg_box.append(pywebio.markdown(${nickname}: ${data['msg']}));
        chat_msgs.push((nickname, data['msg']));
      }

      refresh_task.close();

      online_users.delete(nickname);
      pywebio.toast("Ð’Ñ‹ Ð²Ñ‹ÑˆÐ»Ð¸ Ð¸Ð· Ñ‡Ð°Ñ‚Ð°!");
      msg_box.append(pywebio.markdown(ðŸ“¢ ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ ${nickname} Ð¿Ð¾ÐºÐ¸Ð½ÑƒÐ» Ñ‡Ð°Ñ‚!));
      chat_msgs.push((ðŸ“¢, ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ ${nickname} Ð¿Ð¾ÐºÐ¸Ð½ÑƒÐ» Ñ‡Ð°Ñ‚!));

      pywebio.putButtons(['ÐŸÐµÑ€ÐµÐ·Ð°Ð¹Ñ‚Ð¸'], { onclick: () => pywebio.runJs('window.location.reload()') });
    });

    async function refreshMsg(nickname, msg_box) {
      let last_idx = chat_msgs.length;

      while (true) {
        await pywebio.sleep(1);

        for (const m of chat_msgs.slice(last_idx)) {
          if (m[0] != nickname) { // if not a message from current user
            msg_box.append(pywebio.markdown(${m[0]}: ${m[1]}));
          }
        }

        // remove expired
        if (chat_msgs.length > MAX_MESSAGES_COUNT) {
          chat_msgs = chat_msgs.slice(chat_msgs.length / 2);
        }

        last_idx = chat_msgs.length;
      }
    }
  </script>
</body>
</html>
